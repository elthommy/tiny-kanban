name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test-and-lint:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        # Future: Add other Linux distributions here
        # os: [ubuntu-latest, ubuntu-22.04, ubuntu-20.04]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Setup Python for backend
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'backend/pyproject.toml'

    # Setup Node.js for frontend
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'

    # Backend: Install dependencies
    - name: Install backend dependencies
      run: |
        cd backend
        pip install -e ".[dev]"

    # Frontend: Install dependencies
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    # Backend: Run tests
    - name: Run backend tests
      run: |
        cd backend
        pytest -v

    # Frontend: Run tests
    - name: Run frontend tests
      run: |
        cd frontend
        npx vitest run

    # Backend: Check code formatting with Black
    - name: Check backend formatting (Black)
      run: |
        cd backend
        black --check --diff app/ tests/

    # Backend: Lint with pyflakes
    - name: Lint backend (pyflakes)
      run: |
        cd backend
        pyflakes app/ tests/

    # Frontend: Check code formatting with Prettier
    - name: Check frontend formatting (Prettier)
      run: |
        cd frontend
        npx prettier --check 'src/**/*.{ts,tsx,css}'

    # Frontend: Lint with ESLint
    - name: Lint frontend (ESLint)
      run: |
        cd frontend
        npx eslint . --max-warnings 0
